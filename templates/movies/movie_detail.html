{% extends 'base.html' %}
{% load static i18n %}
{% load i18n %}

{% block title %}{{ movie.title_uz }} ({{ movie.year }}) - {{ SITE_NAME }}{% endblock %}

{% block meta_description %}{{ movie.description_uz|truncatewords:25 }}{% endblock %}
{% block meta_keywords %}{{ movie.title_az|default:movie.title_uz }}, {% for genre in movie.genres.all %}{{ genre.name_az|default:genre.name_uz }}, {% endfor %}{% for actor in movie.actors.all|slice:":5" %}{{ actor.name }}, {% endfor %}{{ movie.year }}{% endblock %}

{% block og_title %}{{ movie.title_uz }} ({{ movie.year }}) - Onlayn tomosha qiling{% endblock %}
{% block og_description %}{{ movie.description_uz|truncatewords:25 }}{% endblock %}
{% block og_image %}{{ movie.poster.url }}{% endblock %}


{% block extra_css %}
<style>
    .movie-detail-hero {
        position: relative;
        height: 500px;
        background-size: cover;
        background-position: center;
        margin-top: -80px;
        padding-top: 80px;
    }
    
    .movie-detail-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, rgba(18, 18, 18, 0.3) 0%, rgba(18, 18, 18, 0.95) 100%);
    }
    
    .detail-content {
        position: relative;
        z-index: 2;
        padding-top: 120px;
    }
    
    .detail-poster {
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        width: 100%;
        max-width: 350px;
    }
    
    .rating-widget {
        display: flex;
        gap: 5px;
        font-size: 2rem;
        cursor: pointer;
    }
    
    
    .rating-widget .star {
        color: #555;
        transition: color 0.2s ease;
    }
    
    .rating-widget .star.active,
    .rating-widget .star:hover,
    .rating-widget .star:hover ~ .star {
        color: #ffc107;
    }
    
    .comment-section {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 30px;
        margin-top: 30px;
    }
    
    .comment-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    
    .comment-author {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .comment-date {
        font-size: 0.85rem;
        color: var(--text-gray);
    }
    
    .trailer-modal .modal-content {
        background: #000;
    }
    
    .trailer-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
    }
    
    .trailer-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="movie-detail-hero" style="background-image: url('{% if movie.backdrop %}{{ movie.backdrop.url }}{% elif movie.poster %}{{ movie.poster.url }}{% else %}{% static 'img/no-poster.png' %}{% endif %}');">
    <!-- Этот блок теперь только для фона -->
</div>

<!-- Main Content -->
<div class="container detail-content" style="margin-top: -250px; position: relative; z-index: 2;">
    <div class="row">
        <!-- Левая колонка с постером -->
        <div class="col-lg-4 mb-4">
            <img src="{% if movie.poster %}{{ movie.poster.url }}{% else %}{% static 'img/no-poster.png' %}{% endif %}" alt="{{ movie.title_uz }}" class="detail-poster">
        </div>

        <!-- Правая колонка с информацией -->
        <div class="col-lg-8">
            <h1 class="display-4 fw-bold mb-3">
                {{ movie.title_uz }}
            </h1>

            {% if movie.original_title and movie.original_title != movie.title_uz %}
            <p class="text-muted h5 mb-4">{{ movie.original_title }}</p>
            {% endif %}

            <div class="d-flex flex-wrap gap-4 mb-4">
                <div>
                    <span class="text-white"><i class="fas fa-calendar"></i> {% trans "Год" %}:</span>
                    <strong class="text-danger">{{ movie.year }}</strong>
                </div>
                {% if movie.duration %}
                <div>
                    <span class="text-white"><i class="fas fa-clock"></i> {% trans "Длительность" %}:</span>
                    <strong class="text-danger">{{ movie.duration }} {% trans "мин" %}</strong>
                </div>
                {% endif %}
                <div>
                    <span class="text-white"><i class="fas fa-eye"></i> {% trans "Просмотры" %}:</span>
                    <strong class="text-danger">{{ movie.views }}</strong>
                </div>
                <div>
                    <span class="text-white"><i class="fas fa-star text-warning"></i> {% trans "Рейтинг" %}:</span>
                    <strong class="text-danger">{{ movie.rating_avg|floatformat:1 }} / 5.0</strong>
                    <small class="text-white">({{ movie.rating_count }} {% trans "оценок" %})</small>
                </div>
            </div>

            <div class="mb-4">
                <strong><i class="fas fa-list"></i> {% trans "Janrlar" %}:</strong>
                {% for genre in movie.genres.all %}
                <a href="{% url 'genre' genre.slug %}" class="badge bg-danger text-white ms-2">
                    {{ genre.name_az|default:genre.name_uz }}
                </a>
                {% empty %}
                 <span class="ms-2 text-muted">{% trans "Не указано" %}</span>
                {% endfor %}
            </div>

            <div class="mb-4">
                <strong><i class="fas fa-globe"></i> {% trans "Страны" %}:</strong>
                {% for country in movie.countries.all %}
                <span class="badge bg-secondary ms-2">
                    {{ country.name_az|default:country.name_uz }}
                </span>
                {% empty %}
                <span class="ms-2 text-muted">{% trans "Не указано" %}</span>
                {% endfor %}
            </div>

            <div class="d-flex flex-wrap gap-3 mb-4">
                {% if movie.video_file %}
                <a href="{{ movie.video_file.url }}" class="btn btn-danger btn-lg" target="_blank">
                    <i class="fas fa-play-circle"></i> Filmə bax
                </a>
                {% endif %}
                {% if movie.trailer_url %}
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#trailerModal">
                    <i class="fas fa-play"></i> Treylerə bax
                </button>
                {% endif %}

                {% if user.is_authenticated %}
                <button class="btn btn-outline-light favorite-btn" data-type="movie" data-id="{{ movie.id }}">
                    <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                    {% trans "Избранное" %}
                </button>
                <button class="btn btn-outline-light watchlist-btn" data-type="movie" data-id="{{ movie.id }}">
                    <i class="{% if in_watchlist %}fas{% else %}far{% endif %} fa-bookmark"></i>
                    {% trans "Мой список" %}
                </button>
                {% endif %}

                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#shareModal">
                    <i class="fas fa-share-alt"></i> {% trans "Поделиться" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Описание и Актеры -->
<div class="container my-5">
     <!-- Schema.org markup for SEO -->
     <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Movie",
        "name": "{{ movie.title_uz }}",
        "image": "{% if movie.poster %}{{ movie.poster.url }}{% else %}{% static 'img/no-poster.png' %}{% endif %}",
        "datePublished": "{{ movie.year }}",
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "{{ movie.rating_avg }}",
            "ratingCount": "{{ movie.rating_count }}",
            "bestRating": "5",
            "worstRating": "1"
        },
        "description": "{{ movie.description_uz|striptags }}",
        "director": [
            {% for director in movie.directors.all %}
            {
                "@type": "Person",
                "name": "{{ director.name }}"
            },
            {% endfor %}
        ],
        "actor": [
            {% for actor in movie.actors.all|slice:":10" %}
            {
                "@type": "Person",
                "name": "{{ actor.name }}"
            },
            {% endfor %}
        ]
    }
    </script>

    <div class="row">
        <div class="col-lg-8">
            <h2 class="mb-4"><i class="fas fa-info-circle"></i> {% trans "Описание" %}</h2>
            <div class="content-text">
                {{ movie.description_az|default:movie.description_uz|safe }}
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Cast & Crew -->
            {% if movie.directors.all %}
            <div class="mb-4">
                <h5><i class="fas fa-user-tie"></i> {% trans "Режиссеры" %}</h5>
                <ul class="list-unstyled">
                    {% for director in movie.directors.all %}
                    <li>{{ director.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if movie.actors.all %}
            <div class="mb-4">
                <h5><i class="fas fa-users"></i> {% trans "В ролях" %}</h5>
                <ul class="list-unstyled">
                    {% for actor in movie.actors.all|slice:":10" %}
                    <li>{{ actor.name }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Rating Section -->
    {% if user.is_authenticated %}
    <div class="row mt-5">
        <div class="col-lg-8">
            <div class="comment-section">
                <h3 class="mb-4"><i class="fas fa-star"></i> {% trans "Оцените фильм" %}</h3>
                <div class="rating-widget" id="ratingWidget" data-movie-id="{{ movie.id }}">
                    {% for i in "12345" %}
                    <span class="star {% if user_rating and forloop.counter <= user_rating %}active{% endif %}" data-value="{{ forloop.counter }}">
                        <i class="fas fa-star"></i>
                    </span>
                    {% endfor %}
                </div>
                <p class="mt-2 text-white">
                    {% if user_rating %}
                        {% trans "Ваша оценка" %}: <strong class="text-danger">{{ user_rating }}/5</strong>
                    {% else %}
                        {% trans "Нажмите на звезду для оценки" %}
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Comments Section -->
    <div class="row">
        <div class="col-lg-8">
            <div class="comment-section">
                <h3 class="mb-4">
                    <i class="fas fa-comments"></i> 
                    {% trans "Комментарии" %} ({{ comments.count }})
                </h3>
                
                {% if user.is_authenticated %}
                <form id="commentForm" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea class="form-control" name="text" rows="4" placeholder="{% trans 'Ваш комментарий...' %}" required></textarea>
                    </div>
                    
                    <!-- Google reCAPTCHA (отключена для разработки) -->
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> {% trans "reCAPTCHA отключена для разработки" %}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="commentSubmitBtn">
                        <i class="fas fa-paper-plane"></i> {% trans "Отправить" %}
                    </button>
                    <p class="text-white small mt-2">
                        <i class="fas fa-info-circle"></i> {% trans "Комментарии проходят модерацию" %}
                    </p>
                </form>
                {% else %}
                <p class="alert alert-info">
                    <i class="fas fa-sign-in-alt"></i>
                    <a href="{% url 'account_login' %}">{% trans "Войдите" %}</a> {% trans "чтобы оставить комментарий" %}
                </p>
                {% endif %}
                
                <!-- Comments List -->
                <div id="commentsList">
                    {% for comment in comments %}
                    <div class="comment-item">
                        <div class="comment-author">
                            <i class="fas fa-user-circle"></i> {{ comment.user.username }}
                        </div>
                        <div class="comment-date">{{ comment.created_at|date:"d M Y, H:i" }}</div>
                        <div class="comment-text mt-2">{{ comment.text }}</div>
                    </div>
                    {% empty %}
                    <p class="text-white">{% trans "Пока нет комментариев" %}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Similar Movies -->
    {% if similar_movies %}
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4"><i class="fas fa-film"></i> {% trans "Похожие фильмы" %}</h3>
            <div class="content-grid">
                {% for similar in similar_movies %}
                <div class="movie-card">
                    <div class="movie-poster">
                        <img src="{{ similar.poster.url }}" alt="{{ similar.title_uz }}" loading="lazy">
                    </div>
                    <div class="movie-info">
                        <h3 class="movie-title">
                            <a href="{{ similar.get_absolute_url }}">
                                {{ similar.title_uz }}
                            </a>
                        </h3>
                        <div class="movie-meta">
                            <span>{{ similar.year }}</span>
                            <span class="movie-rating">
                                <i class="fas fa-star"></i> {{ similar.rating_avg|floatformat:1 }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Trailer Modal -->
{% if movie.trailer_url %}
<div class="modal fade trailer-modal" id="trailerModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="trailer-container" id="trailerContainer"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/favorites.js' %}"></script>
<script>
    // Rating functionality
    $('#ratingWidget .star').on('click', function() {
        const rating = $(this).data('value');
        const movieId = $('#ratingWidget').data('movie-id');
        
        $.ajax({
            url: `/api/movies/${movieId}/rate/`,
            method: 'POST',
            data: { score: rating },
            success: function(response) {
                $('#ratingWidget .star').removeClass('active');
                $('#ratingWidget .star').each(function(index) {
                    if (index < rating) {
                        $(this).addClass('active');
                    }
                });
                showToast('Спасибо за оценку!', 'success');
                // Reload page to update average rating
                setTimeout(() => location.reload(), 1500);
            },
            error: function() {
                showToast('Ошибка при сохранении оценки', 'danger');
            }
        });
    });
    
    // Comment submission - более надежная версия
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎬 Movie detail page loaded');
        
        const commentForm = document.getElementById('commentForm');
        const commentSubmitBtn = document.getElementById('commentSubmitBtn');
        
        console.log('Comment form found:', !!commentForm);
        console.log('Comment submit button found:', !!commentSubmitBtn);
        
        if (commentForm && commentSubmitBtn) {
            console.log('✅ Comment form initialized');
            
            // Функция отправки комментария
            function submitComment() {
                console.log('🔥 Comment form submitted');
                
                const textarea = commentForm.querySelector('textarea[name="text"]');
                const text = textarea.value.trim();
                
                console.log('Comment text:', text);
                
                if (!text) {
                    console.log('❌ Empty comment text');
                    showToast('Введите текст комментария', 'warning');
                    textarea.focus();
                    return false;
                }
                
                console.log('✅ Comment text is valid, submitting...');
                
                // Отключаем кнопку на время отправки
                commentSubmitBtn.disabled = true;
                commentSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                
                const formData = {
                    content_type: 'movie',
                    movie: {{ movie.id }},
                    text: text
                };
                
                console.log('Sending AJAX request to /api/comments/');
                console.log('Form data:', formData);
                
                $.ajax({
                    url: '/api/comments/',
                    method: 'POST',
                    data: formData,
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        console.log('✅ Comment submitted successfully:', response);
                        showToast('Комментарий отправлен на модерацию', 'success');
                        // Очищаем поле ввода
                        textarea.value = '';
                        textarea.focus();
                        // Также очищаем форму полностью
                        commentForm.reset();
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Comment submission error:', error);
                        console.error('XHR status:', xhr.status);
                        console.error('XHR response:', xhr.responseText);
                        showToast('Ошибка при отправке комментария', 'danger');
                    },
                    complete: function() {
                        console.log('🔄 AJAX request completed');
                        // Восстанавливаем кнопку
                        commentSubmitBtn.disabled = false;
                        commentSubmitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить';
                    }
                });
            }
            
            // Обработчик отправки формы
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitComment();
            });
            
            // Обработчик клика по кнопке - точно как Enter
            commentSubmitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('🔥 Comment button clicked');
                submitComment();
            });
            
            // Обработчик Enter в поле комментария
            const textarea = commentForm.querySelector('textarea[name="text"]');
            if (textarea) {
                textarea.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('🔥 Comment Enter pressed');
                        submitComment();
                    }
                });
            }
        } else {
            console.log('❌ Comment form or button not found');
        }
    });
    
    // Load trailer on modal open
    {% if movie.trailer_url %}
    $('#trailerModal').on('shown.bs.modal', function() {
        initVideoPlayer('trailerContainer', '{{ movie.trailer_url }}');
    });
    
    $('#trailerModal').on('hidden.bs.modal', function() {
        $('#trailerContainer').html('');
    });
    {% endif %}
</script>

<!-- Модальное окно для выбора социальных сетей -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share-alt"></i> {% trans "Поделиться фильмом" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    {% trans "Выберите социальную сеть для отправки ссылки на фильм" %}
                </p>
                
                <div class="row g-3">
                    <!-- Telegram -->
                    <div class="col-6 col-md-4">
                        <button class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" 
                                onclick="shareToTelegram()">
                            <i class="fab fa-telegram-plane fa-2x mb-2"></i>
                            <span>Telegram</span>
                        </button>
                    </div>
                    
                    <!-- WhatsApp (заготовка) -->
                    <div class="col-6 col-md-4">
                        <button class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" 
                                onclick="shareToWhatsApp()">
                            <i class="fab fa-whatsapp fa-2x mb-2"></i>
                            <span>WhatsApp</span>
                        </button>
                    </div>
                    
                    <!-- VK (заготовка) -->
                    <div class="col-6 col-md-4">
                        <button class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" 
                                onclick="shareToVK()">
                            <i class="fab fa-vk fa-2x mb-2"></i>
                            <span>VKontakte</span>
                        </button>
                    </div>
                    
                    <!-- Facebook (заготовка) -->
                    <div class="col-6 col-md-4">
                        <button class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" 
                                onclick="shareToFacebook()">
                            <i class="fab fa-facebook fa-2x mb-2"></i>
                            <span>Facebook</span>
                        </button>
                    </div>
                    
                    <!-- Twitter (заготовка) -->
                    <div class="col-6 col-md-4">
                        <button class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" 
                                onclick="shareToTwitter()">
                            <i class="fab fa-twitter fa-2x mb-2"></i>
                            <span>Twitter</span>
                        </button>
                    </div>
                    
                    <!-- Копировать ссылку -->
                    <div class="col-6 col-md-4">
                        <button class="btn btn-outline-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" 
                                onclick="copyToClipboard()">
                            <i class="fas fa-copy fa-2x mb-2"></i>
                            <span>{% trans "Копировать" %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Функции для шаринга в социальные сети
function shareToTelegram() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ movie.title_uz|escapejs }}');
    const text = encodeURIComponent('{% trans "Посмотрите этот фильм" %}: ');
    const telegramUrl = `https://t.me/share/url?url=${url}&text=${text}${title}`;
    window.open(telegramUrl, '_blank', 'width=600,height=400');
    $('#shareModal').modal('hide');
}

function shareToWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('{% trans "Посмотрите этот фильм" %}: {{ movie.title_uz|escapejs }}');
    const whatsappUrl = `https://api.whatsapp.com/send?text=${text}%20${url}`;
    window.open(whatsappUrl, '_blank');
    $('#shareModal').modal('hide');
}

function shareToVK() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ movie.title_uz|escapejs }}');
    const vkUrl = `https://vk.com/share.php?url=${url}&title=${title}`;
    window.open(vkUrl, '_blank', 'width=600,height=400');
    $('#shareModal').modal('hide');
}

function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    window.open(facebookUrl, '_blank', 'width=600,height=400');
    $('#shareModal').modal('hide');
}

function shareToTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('{% trans "Посмотрите этот фильм" %}: {{ movie.title_uz|escapejs }}');
    const twitterUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
    window.open(twitterUrl, '_blank', 'width=600,height=400');
    $('#shareModal').modal('hide');
}

function copyToClipboard() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(function() {
        showToast('{% trans "Ссылка скопирована в буфер обмена" %}', 'success');
        $('#shareModal').modal('hide');
    }).catch(function() {
        // Fallback для старых браузеров
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('{% trans "Ссылка скопирована в буфер обмена" %}', 'success');
        $('#shareModal').modal('hide');
    });
}
</script>
{% endblock %}

